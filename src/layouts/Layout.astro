---
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import { getLangFromUrl, useTranslations, translatePath } from '../lib/i18n/utils';
import "../styles/styles.css";

interface Props {
  title: string;
  page?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const {
  title,
  page = "",
  description = t('meta.description'),
  canonical = "https://jjmontalban.com",
  ogImage = "https://jjmontalban.com/assets/og-profile.jpg",
} = Astro.props as Props;

const currentPath = Astro.url?.pathname ?? "/";
const canonicalUrl = canonical.replace(/\/$/, "") + currentPath;

// Alternate language URL for hreflang
const alternateLang = lang === 'es' ? 'en' : 'es';
const alternatePath = translatePath(currentPath, alternateLang);
const alternateUrl = canonical.replace(/\/$/, "") + alternatePath;
---

<!doctype html>
<html lang={lang}>
  <head>

    <!-- GA4 Internal Traffic Filter -->
    <script is:inline>
      (function() {
        const gaId = 'G-FS8BJFW7H8';
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.get('admin') === 'true') {
          localStorage.setItem('exclude_ga', 'true');
          alert('Filtro activado: Tus visitas a jjmontalban.com ya no se contarán en este navegador.');
        }

        if (localStorage.getItem('exclude_ga') === 'true') {
          window['ga-disable-' + gaId] = true;
          console.log('Google Analytics bloqueado para tráfico interno.');
        }
      })();
    </script>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="author" content="JJMontalban" />
    <meta name="theme-color" content="#111111" />

    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang={lang} href={canonicalUrl} />
    <link rel="alternate" hreflang={alternateLang} href={alternateUrl} />
    <link rel="alternate" hreflang="x-default" href={canonical + "/"} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content="JJMontalban" />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
    <meta property="og:locale:alternate" content={lang === 'es' ? 'en_US' : 'es_ES'} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Critical CSS inline for faster LCP -->
    <style is:inline>
      @font-face{font-family:'Cubano';src:url('/fonts/Cubano.woff2') format('truetype');font-weight:400;font-style:normal;font-display:swap}
      @font-face{font-family:'Roboto Mono';src:url('/fonts/RobotoMono-Regular.woff2') format('truetype');font-weight:100 900;font-style:normal;font-display:swap}
      :root{--shadow-deep-black:-1px 0 #000,1px 0 #000,0 -1px #000,0 1px #000,-2px 2px #000,-3px 3px #000,-4px 4px #000,-5px 5px #000,-6px 6px #000,-7px 7px #000,-8px 8px #000;--shadow-outline-white:-1px 0 #FFF,1px 0 #FFF,0 -1px #FFF,0 1px #FFF,-2px 2px #FFF}
      html{-webkit-text-size-adjust:100%;text-size-adjust:100%;height:100%}
      body{font-family:'Roboto Mono',monospace;font-weight:350;font-size:16px;line-height:1.6;max-width:88%;margin:auto;transition:background-color .35s ease,color .35s ease}
      body.page-home{--page-bg:#fff;--page-fg:#111;--heading-color:#fff;--heading-shadow:var(--shadow-deep-black);--nav-text-color:var(--page-bg);--nav-text-shadow:var(--shadow-deep-black);background-color:var(--page-bg);color:var(--page-fg)}
      body.page-servicios{--page-bg:#6a00f4;--page-fg:#fff;--heading-color:var(--page-bg);--heading-shadow:var(--shadow-outline-white);--nav-text-color:var(--page-bg);--nav-text-shadow:var(--shadow-outline-white);background-color:var(--page-bg);color:var(--page-fg)}
      body.page-casos{--page-bg:#254ea5;--page-fg:#fff;--heading-color:var(--page-bg);--heading-shadow:var(--shadow-outline-white);--nav-text-color:var(--page-bg);--nav-text-shadow:var(--shadow-outline-white);background-color:var(--page-bg);color:var(--page-fg)}
      body.page-contacto{--page-bg:#7f1d1d;--page-fg:#fff;--heading-color:var(--page-bg);--heading-shadow:var(--shadow-outline-white);--nav-text-color:var(--page-bg);--nav-text-shadow:var(--shadow-outline-white);background-color:var(--page-bg);color:var(--page-fg)}
      body.page-plugins{--page-bg:#0f766e;--page-fg:#fff;--heading-color:var(--page-bg);--heading-shadow:var(--shadow-outline-white);--nav-text-color:var(--page-bg);--nav-text-shadow:var(--shadow-outline-white);background-color:var(--page-bg);color:var(--page-fg)}
      .navbar{font-family:"Cubano",sans-serif;display:flex;justify-content:space-between;align-items:center;padding:24px 0;background-color:transparent;position:relative}
      .nav-links{display:flex;align-items:center}
      .nav-links a{font-size:2.5em;position:relative;padding:8px 12px;font-weight:400;color:var(--nav-text-color);text-shadow:var(--nav-text-shadow)}
      .site-logo{display:block;height:40px;width:auto}
      .page-servicios .site-logo,.page-casos .site-logo,.page-plugins .site-logo,.page-contacto .site-logo{filter:invert(1)}
      .burger{display:none}
      @media(max-width:991px){.nav-links{display:none}.burger{display:block;background:none;border:none;font-size:32px;cursor:pointer;color:inherit}}
    </style>

    <!-- Preload critical assets -->
    <link rel="preload" href="/images/jj.webp" as="image" type="image/webp" fetchpriority="high" />
    <link rel="preload" href="/fonts/RobotoMono-Regular.woff2" as="font" type="font/woff2" crossorigin />
    <link rel="preload" href="/fonts/Cubano.woff2" as="font" type="font/woff2" crossorigin />


    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "JJMontalban",
      "jobTitle": t('meta.jobTitle'),
      "url": "https://jjmontalban.com/",
      "sameAs": [
        "https://github.com/jjmontalban",
        "https://www.linkedin.com/in/jjmontalban/",
        "https://profiles.wordpress.org/jjmontalban/"
      ],
      "image": "https://jjmontalban.com/images/profile.jpg",
      "description": t('meta.jobDescription'),
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Chipiona",
        "addressRegion": "Andalucía",
        "addressCountry": lang === 'es' ? "España" : "Spain"
      },
      "knowsLanguage": ["es", "en"]
    })} />

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/images/favicon.svg" />
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  </head>

  <body class={page}>
    <Navbar current={page?.replace("page-", "")} />

    <main id="main-content" class="main">
      <slot />
    </main>

    <Footer />

    <script>
      document.documentElement.classList.remove("page-enter");
      requestAnimationFrame(() => {
        document.documentElement.classList.add("page-enter");
      });
    </script>

    <script src="/scripts/nav.js" defer></script>

    <!-- Scroll Reveal Animation -->
    <script>
      const initReveal = () => {
        const revealElements = document.querySelectorAll('.reveal');

        if (revealElements.length === 0) return;

        const observer = new IntersectionObserver((entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              entry.target.classList.add('revealed');
              observer.unobserve(entry.target);
            }
          });
        }, {
          threshold: 0.1,
          rootMargin: '0px 0px -50px 0px'
        });

        revealElements.forEach((el) => observer.observe(el));
      };

      // Run on initial load and after Astro page transitions
      document.addEventListener('DOMContentLoaded', initReveal);
      document.addEventListener('astro:page-load', initReveal);
    </script>
  </body>
</html>
