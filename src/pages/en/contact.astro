---
import Layout from "../../layouts/Layout.astro";
import { useTranslations } from '../../lib/i18n/utils';
import type { Lang } from '../../lib/i18n/utils';

const lang: Lang = 'en';
const t = useTranslations(lang);
---

<Layout
  title={t('contacto.meta.title')}
  page="page-contacto"
  description={t('contacto.meta.description')}
>
  <div class="container">
    <section>

      <h1>{t('contacto.title')}</h1>
      <p>{t('contacto.intro')}</p>

      <div class="contact-card">
        <!-- Success message -->
        <div id="form-success" class="form-message form-success" hidden>
          <h2>{t('contacto.exito.titulo')}</h2>
          <p>{t('contacto.exito.mensaje')}</p>
          <button type="button" class="cta" id="send-another">{t('contacto.enviarOtro')}</button>
        </div>

        <!-- Error message -->
        <div id="form-error" class="form-message form-error" hidden>
          <h2>{t('contacto.error.titulo')}</h2>
          <p id="error-text">{t('contacto.error.mensaje')}</p>
          <button type="button" class="cta" id="try-again">{t('contacto.enviar')}</button>
        </div>

        <form
          id="contact-form"
          class="contact-form"
          action="https://formspree.io/f/mzdbogkk"
          method="POST"
          novalidate
        >
          <label for="name">{t('contacto.nombre')}</label>
          <input
            id="name"
            name="name"
            type="text"
            placeholder={t('contacto.nombrePlaceholder')}
            required
            aria-describedby="name-error"
          />
          <span id="name-error" class="field-error" hidden>{t('contacto.error.nombre')}</span>

          <label for="email">{t('contacto.email')}</label>
          <input
            id="email"
            name="_replyto"
            type="email"
            placeholder={t('contacto.emailPlaceholder')}
            required
            aria-describedby="email-error"
          />
          <span id="email-error" class="field-error" hidden>{t('contacto.error.email')}</span>

          <button type="button" class="toggle-optional cta" aria-expanded="false" aria-controls="optional-fields" data-show-text={t('contacto.masDetalles')} data-hide-text={t('contacto.ocultarDetalles')}>
            {t('contacto.masDetalles')}
          </button>
          <div id="optional-fields" class="optional-fields" hidden>
            <label for="project-type">{t('contacto.tipoProyecto')}</label>
            <fieldset class="optional-group">
              <label>
                <input type="checkbox" name="project_type[]" value="Corporate website" />
                {t('contacto.webCorporativa')}
              </label>
              <label>
                <input type="checkbox" name="project_type[]" value="E-commerce" />
                {t('contacto.ecommerce')}
              </label>
              <label>
                <input type="checkbox" name="project_type[]" value="Plugin / custom development" />
                {t('contacto.pluginMedida')}
              </label>
              <label>
                <input type="checkbox" name="project_type[]" value="Web application / custom system" />
                {t('contacto.appWeb')}
              </label>
              <label>
                <input type="checkbox" name="project_type[]" value="Not sure" />
                {t('contacto.noLoSeClaro')}
              </label>
            </fieldset>

            <label for="has-website">{t('contacto.tieneWeb')}</label>
            <select id="has-website" name="has_website">
              <option value="" selected>{t('contacto.seleccionaOpcion')}</option>
              <option value="Yes">{t('contacto.si')}</option>
              <option value="No">{t('contacto.no')}</option>
              <option value="In development">{t('contacto.enDesarrollo')}</option>
            </select>

            <div class="optional-dependent" data-show="has-website" hidden>
              <label for="current-url">{t('contacto.urlActual')}</label>
              <input id="current-url" name="current_url" type="url" />
            </div>

            <div class="optional-dependent" data-show="has-website" hidden>
              <label for="current-hosting">{t('contacto.hostingActual')}</label>
              <input
              id="current-hosting"
              name="current_hosting"
              type="text"
              placeholder={t('contacto.hostingPlaceholder')}
              />
            </div>

            <div class="optional-dependent" data-show="has-website" hidden>
              <label for="experience-level">
                {t('contacto.nivelExperiencia')}
              </label>
              <select id="experience-level" name="experience_level">
                <option value="" selected>{t('contacto.seleccionaOpcion')}</option>
                <option value="None">{t('contacto.ninguna')}</option>
                <option value="Basic (publish content)">
                  {t('contacto.basica')}
                </option>
                <option value="Medium (editing, settings, plugins)">
                  {t('contacto.media')}
                </option>
                <option value="Advanced">{t('contacto.avanzada')}</option>
              </select>
            </div>

            <label for="agency-collab">
              {t('contacto.colaboracionAgencia')}
            </label>
            <select id="agency-collab" name="agency_collaboration">
              <option value="" selected>{t('contacto.seleccionaOpcion')}</option>
              <option value="Yes">{t('contacto.si')}</option>
              <option value="No">{t('contacto.no')}</option>
            </select>

            <div class="optional-dependent" data-show="agency-yes" hidden>
              <label for="agency-name">{t('contacto.nombreAgencia')}</label>
              <input id="agency-name" name="agency_name" type="text" />
            </div>

            <fieldset class="optional-dependent" data-show="agency-no" hidden>
              <legend>{t('contacto.materialCorporativo')}</legend>
              <label>
                <input type="checkbox" name="brand_assets[]" value="Logo" />
                {t('contacto.logotipo')}
              </label>
              <label>
                <input type="checkbox" name="brand_assets[]" value="Corporate colors" />
                {t('contacto.coloresCorporativos')}
              </label>
              <label>
                <input type="checkbox" name="brand_assets[]" value="Fonts" />
                {t('contacto.tipografias')}
              </label>
              <label>
                <input type="checkbox" name="brand_assets[]" value="Brand manual" />
                {t('contacto.manualMarca')}
              </label>
              <label>
                <input type="checkbox" name="brand_assets[]" value="Professional photos" />
                {t('contacto.fotografiasProfesionales')}
              </label>
              <label>
                <input type="checkbox" name="brand_assets[]" value="None / to be defined" />
                {t('contacto.ningunoPorDefinir')}
              </label>
            </fieldset>

            <label for="message">{t('contacto.mensaje')}</label>
            <textarea
            id="message"
            name="message"
            rows="5"
            placeholder={t('contacto.mensajePlaceholder')}
            ></textarea>
          </div>

          <input type="hidden" name="_subject" value={t('contacto.asuntoEmail')} />
          <input type="text" name="_gotcha" style="display:none" />
          <label id="quick-submit-label" for="message">{t('contacto.quickSubmit')}</label>
          <button type="submit" class="cta" id="submit-btn" data-text={t('contacto.enviar')} data-loading={t('contacto.enviando')}>
            {t('contacto.enviar')}
          </button>
        </form>
      </div>
    </div>

  </section>
  <script>
    const form = document.getElementById("contact-form") as HTMLFormElement | null;
    const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement | null;
    const formSuccess = document.getElementById("form-success");
    const formError = document.getElementById("form-error");
    const errorText = document.getElementById("error-text");
    const sendAnother = document.getElementById("send-another");
    const tryAgain = document.getElementById("try-again");
    const nameInput = document.getElementById("name") as HTMLInputElement | null;
    const emailInput = document.getElementById("email") as HTMLInputElement | null;
    const nameError = document.getElementById("name-error");
    const emailError = document.getElementById("email-error");

    const toggleButton = document.querySelector(".toggle-optional") as HTMLButtonElement | null;
    const optionalFields = document.getElementById("optional-fields");
    const hasWebsiteSelect = document.getElementById("has-website") as HTMLSelectElement | null;
    const agencySelect = document.getElementById("agency-collab") as HTMLSelectElement | null;
    const quickSubmitLabel = document.getElementById("quick-submit-label");

    // Email validation regex
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

    // Validate form
    const validateForm = (): boolean => {
      let isValid = true;

      // Validate name
      if (nameInput && nameError) {
        if (!nameInput.value.trim()) {
          nameError.hidden = false;
          nameInput.classList.add("input-error");
          isValid = false;
        } else {
          nameError.hidden = true;
          nameInput.classList.remove("input-error");
        }
      }

      // Validate email
      if (emailInput && emailError) {
        if (!emailInput.value.trim() || !emailRegex.test(emailInput.value)) {
          emailError.hidden = false;
          emailInput.classList.add("input-error");
          isValid = false;
        } else {
          emailError.hidden = true;
          emailInput.classList.remove("input-error");
        }
      }

      return isValid;
    };

    // Clear validation errors on input
    nameInput?.addEventListener("input", () => {
      if (nameError && nameInput.value.trim()) {
        nameError.hidden = true;
        nameInput.classList.remove("input-error");
      }
    });

    emailInput?.addEventListener("input", () => {
      if (emailError && emailRegex.test(emailInput.value)) {
        emailError.hidden = true;
        emailInput.classList.remove("input-error");
      }
    });

    // Form submission
    form?.addEventListener("submit", async (e) => {
      e.preventDefault();

      if (!validateForm()) {
        return;
      }

      // Show loading state
      if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.textContent = submitBtn.dataset.loading || "Sending...";
        submitBtn.classList.add("btn-loading");
      }

      try {
        const formData = new FormData(form);
        const response = await fetch(form.action, {
          method: "POST",
          body: formData,
          headers: {
            "Accept": "application/json"
          }
        });

        if (response.ok) {
          // Show success message
          form.hidden = true;
          formSuccess?.removeAttribute("hidden");
          formError?.setAttribute("hidden", "");
        } else {
          throw new Error("Form submission failed");
        }
      } catch (error) {
        // Show error message
        form.hidden = true;
        formError?.removeAttribute("hidden");
        formSuccess?.setAttribute("hidden", "");
      } finally {
        // Reset button state
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = submitBtn.dataset.text || "Send";
          submitBtn.classList.remove("btn-loading");
        }
      }
    });

    // Send another message
    sendAnother?.addEventListener("click", () => {
      form?.reset();
      form?.removeAttribute("hidden");
      formSuccess?.setAttribute("hidden", "");

      // Reset optional fields
      optionalFields?.setAttribute("hidden", "");
      if (toggleButton) {
        toggleButton.textContent = toggleButton.dataset.showText || "More details";
        toggleButton.setAttribute("aria-expanded", "false");
      }
      quickSubmitLabel?.removeAttribute("hidden");

      // Reset dependent fields
      document.querySelectorAll(".optional-dependent").forEach((field) => {
        field.setAttribute("hidden", "");
      });
      if (hasWebsiteSelect) hasWebsiteSelect.value = "";
      if (agencySelect) agencySelect.value = "";
    });

    // Try again after error
    tryAgain?.addEventListener("click", () => {
      form?.removeAttribute("hidden");
      formError?.setAttribute("hidden", "");
    });

    // Optional fields toggle and dependencies
    const updateWebsiteDependencies = () => {
      if (!hasWebsiteSelect) {
        return;
      }
      const shouldShow = ["Yes", "In development"].includes(hasWebsiteSelect.value);
      document
        .querySelectorAll('[data-show="has-website"]')
        .forEach((field) => field.toggleAttribute("hidden", !shouldShow));
    };

    const updateAgencyDependencies = () => {
      if (!agencySelect) {
        return;
      }
      const isYes = agencySelect.value === "Yes";
      document
        .querySelectorAll('[data-show="agency-yes"]')
        .forEach((field) => field.toggleAttribute("hidden", !isYes));
      document
        .querySelectorAll('[data-show="agency-no"]')
        .forEach((field) => field.toggleAttribute("hidden", isYes || !agencySelect.value));
    };

    if (toggleButton && optionalFields && quickSubmitLabel) {
      toggleButton.addEventListener("click", () => {
          const isHidden = optionalFields.toggleAttribute("hidden");

          // Optional fields - use data attributes for translated text
          const showText = toggleButton.dataset.showText || "Add more details (optional)";
          const hideText = toggleButton.dataset.hideText || "Hide details";
          toggleButton.textContent = isHidden ? showText : hideText;
          toggleButton.setAttribute("aria-expanded", String(!isHidden));

          // Inverse behavior
          quickSubmitLabel.toggleAttribute("hidden", !isHidden);

          if (!isHidden) {
            updateWebsiteDependencies();
            updateAgencyDependencies();
          } else {
            if (hasWebsiteSelect) hasWebsiteSelect.value="";
            if (agencySelect) agencySelect.value="";
            document
              .querySelectorAll(".optional-dependent")
              .forEach((field) => field.setAttribute("hidden",""));
          }
        });
      }

    if (hasWebsiteSelect) {
      hasWebsiteSelect.addEventListener("change", updateWebsiteDependencies);
    }

    if (agencySelect) {
      agencySelect.addEventListener("change", updateAgencyDependencies);
    }

    // Ensure conditional fields are hidden on page load
    document
      .querySelectorAll('.optional-dependent')
      .forEach((field) => field.setAttribute("hidden", ""));
  </script>
</Layout>
