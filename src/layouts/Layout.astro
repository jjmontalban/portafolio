---
import Navbar from "../components/Navbar.astro";
import Footer from "../components/Footer.astro";
import { getLangFromUrl, useTranslations, translatePath } from '../lib/i18n/utils';

interface Props {
  title: string;
  page?: string;
  description?: string;
  canonical?: string;
  ogImage?: string;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const {
  title,
  page = "",
  description = t('meta.description'),
  canonical = "https://jjmontalban.com",
  ogImage = "https://jjmontalban.com/assets/og-profile.jpg",
} = Astro.props as Props;

const currentPath = Astro.url?.pathname ?? "/";
const canonicalUrl = canonical.replace(/\/$/, "") + currentPath;

// Alternate language URL for hreflang
const alternateLang = lang === 'es' ? 'en' : 'es';
const alternatePath = translatePath(currentPath, alternateLang);
const alternateUrl = canonical.replace(/\/$/, "") + alternatePath;
---

<!doctype html>
<html lang={lang}>
  <head>

    <!-- Google Tag Manager -->
    <script is:inline>
      (function() {
        const urlParams = new URLSearchParams(window.location.search);
        // Tu ID real extraído de la captura: G-FS8BJFW7H8
        const gaId = 'G-FS8BJFW7H8'; 

        if (urlParams.get('admin') === 'true') {
          localStorage.setItem('exclude_ga', 'true');
          alert('Filtro activado: Tus visitas a jjmontalban.com ya no se contarán en este navegador.');
        }

        if (localStorage.getItem('exclude_ga') === 'true') {
          window['ga-disable-' + gaId] = true;
          console.log('Google Analytics bloqueado para tráfico interno.');
        }
      })();
    </script>

    <script is:inline>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-WGK2TRNL');</script>
    <!-- End Google Tag Manager -->

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />

    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="author" content="JJMontalban" />
    <meta name="theme-color" content="#111111" />

    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang={lang} href={canonicalUrl} />
    <link rel="alternate" hreflang={alternateLang} href={alternateUrl} />
    <link rel="alternate" hreflang="x-default" href={canonical + "/es"} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:site_name" content="JJMontalban" />
    <meta property="og:locale" content={lang === 'es' ? 'es_ES' : 'en_US'} />
    <meta property="og:locale:alternate" content={lang === 'es' ? 'en_US' : 'es_ES'} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />

    <!-- Preload critical assets -->
    <link rel="preload" href="/images/jj.webp" as="image" type="image/webp" />
    <link rel="preload" href="/fonts/RobotoMono-Regular.ttf" as="font" type="font/ttf" crossorigin />
    <link rel="preload" href="/fonts/Cubano.ttf" as="font" type="font/ttf" crossorigin />

    <!-- Global CSS -->
    <link rel="stylesheet" href="/styles.css" />

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "JJMontalban",
      "jobTitle": t('meta.jobTitle'),
      "url": "https://jjmontalban.com/",
      "sameAs": [
        "https://github.com/jjmontalban",
        "https://www.linkedin.com/in/jjmontalban/",
        "https://profiles.wordpress.org/jjmontalban/"
      ],
      "image": "https://jjmontalban.com/images/profile.jpg",
      "description": t('meta.jobDescription'),
      "address": {
        "@type": "PostalAddress",
        "addressLocality": "Chipiona",
        "addressRegion": "Andalucía",
        "addressCountry": lang === 'es' ? "España" : "Spain"
      },
      "knowsLanguage": ["es", "en"]
    })} />
  </head>

  <body class={page}>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WGK2TRNL"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <Navbar current={page?.replace("page-", "")} />

    <main class="main">
      <slot />
    </main>

    <Footer />

    <script>
      document.documentElement.classList.remove("page-enter");
      requestAnimationFrame(() => {
        document.documentElement.classList.add("page-enter");
      });
    </script>

    <script src="/scripts/nav.js" defer></script>
  </body>
</html>
