---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import ContactCTA from "../../../components/ContactCTA.astro";
import { wordpress, php, mysql, javascript, woocommerce, mailchimp, googlecalendar, under, corel, css, jquery } from "../../../lib/icons";
import { getLangFromUrl, useTranslations } from '../../../i18n/utils';
import { languages } from '../../../i18n/ui';
import type { Lang } from '../../../i18n/utils';

export async function getStaticPaths() {
  const casos = await getCollection("casos");
  const paths = [];

  for (const lang of Object.keys(languages)) {
    for (const caso of casos) {
      paths.push({
        params: { lang, slug: caso.slug },
        props: { caso }
      });
    }
  }

  return paths;
}

const { caso } = Astro.props;
const lang = getLangFromUrl(Astro.url) as Lang;
const t = useTranslations(lang);
const project = caso.data;
const ICONS: Record<string, any> = { wordpress, php, mysql, javascript, woocommerce, mailchimp, googlecalendar, under, corel, css, jquery };

// Helper to get localized content
const getLocalizedText = (field: {es: string, en: string} | string | undefined): string => {
  if (!field) return '';
  if (typeof field === 'string') return field;
  return field[lang] || field.es || '';
};

// Helper for quote
const getLocalizedQuote = (quote: any) => {
  if (!quote) return null;
  if (quote.es && quote.en) {
    return quote[lang] || quote.es;
  }
  return quote;
};

const localizedQuote = getLocalizedQuote(project.quote);
---

<Layout
  title={`${getLocalizedText(project.title)} | JJ Montalban`}
  page="page-casos"
  description={t('caso.meta.description')}
>
  <div class="container">

    <div class="back-nav-container">
      <a href={`/${lang}/casos`} class="back-nav-button">
        <img src="/images/back.svg" alt={t('caso.volver')} class="back-nav-img" />
        <span>{t('caso.volver')}</span>
      </a>
    </div>

    <section class="content-container">

      <h1>{getLocalizedText(project.title)}</h1>
      <p class="lead">{getLocalizedText(project["intro-detail"])}</p>
      {project.image && (
        <div class="case-hero">
          <img src={project.image} alt={getLocalizedText(project.title)} loading="lazy" />
        </div>
      )}

      <section class="case-detail">

        {project.problem && (
          <div class="case-detail-section">
            <h2>{t('caso.problema')}</h2>
            <p>{getLocalizedText(project.problem)}</p>
          </div>
        )}

        {project.solution && (
          <div class="case-detail-section">
            <h2>{t('caso.solucion')}</h2>
            <p>{getLocalizedText(project.solution)}</p>
            {project["solution-image"] && (
              <div class="case-hero">
                <img src={project["solution-image"]} alt={`${t('caso.solucion')} ${getLocalizedText(project.title)}`} loading="lazy" />
              </div>
            )}
          </div>
        )}

        {project.result && (
          <div class="case-detail-section">
            <h2>{t('caso.resultado')}</h2>
            <p>{getLocalizedText(project.result)}</p>
          </div>
        )}

        {localizedQuote && (
          <div class="case-detail-section case-quote">
            <p class="case-quote-text">"{localizedQuote.text}"</p>
            <p class="case-quote-author">â€” {localizedQuote.author}</p>
          </div>
        )}

        {project.tech && (
          <div class="case-tech-centered">

            <ul class="case-tech">
              {project.tech.map((key: string) => (
                ICONS[key] && (
                  <li>
                    <svg {...ICONS[key].attributes} set:html={ICONS[key].body} />
                    <span class="sr-only">{key}</span>
                  </li>
                )
              ))}
            </ul>
            
            <div class="case-tech-row">  
              <a class="cta" href={project.link} target="_blank" rel="noopener noreferrer">
                {t('caso.verSitio')}
              </a> 
            </div>

          </div>
        )}

      </section>

    </section>
  </div>
      <ContactCTA
      title={t('caso.cta.title')}
      text={t('caso.cta.text')}
    />
  </div>
</Layout>
